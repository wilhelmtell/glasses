#!/bin/bash

cache() {
  for pair in "$@";
  do
    local key=${pair%:*}
    local value="${pair#*:}"
    echo "$key ?= $value" >>configure.mk
  done
}

rm -f configure.mk

while [[ $# -ge 1 ]];
do
  case "$1" in
    --prefix)
      if [ $# -eq 1 ];
      then
        echo "error: expected prefix value: --prefix <value>" >&2
        exit 1
      fi
      prefix="$2"
      shift
      ;;
    --prefix=*)
      prefix="${1#*=}"
      ;;
    --cxx)
      if [ $# -eq 1 ];
      then
        echo "error: expected cxx value: --cxx <value>" >&2
        exit 1
      fi
      CXX="$2"
      shift
      ;;
    --cxx=*)
      CXX="${1#*=}"
      ;;
    --cxxflags)
      if [ $# -eq 1 ];
      then
        echo "error: expected cxxflags value: --cxxflags <value>" >&2
        exit 1
      fi
      CXXFLAGS="$2"
      shift
      ;;
    --cxxflags=*)
      CXXFLAGS="${1#*=}"
      ;;
    *)
      echo "error: unknown option ${1%=*}." >&2
      exit 1
      ;;
  esac
  shift
done

cache \
  VERSION:"${VERSION:-$(bash tools/version.bash)}" \
  prefix:"${prefix:-"${HOME}/usr/local/stow/$(basename $(pwd))"}" \
  CXX:"${CXX:-g++}" \
  CXXFLAGS:"${CXXFLAGS:--std=c++14}" \
  ALL_SOURCE_FILES:"${ALL_SOURCE_FILES:-$(find src test -name '*.hh' -o -name '*.tcc' -o -name '*.cc' |tr '\n' ' ')}" \
  LIBRARIES:"${LIBRARIES:-boost_signals}"
